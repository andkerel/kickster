<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Awkward Moment</title>

<link rel="stylesheet" href="main.css">
<link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900' rel='stylesheet' type='text/css'>

<script src="https://cdn.socket.io/socket.io-1.3.4.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script src="js/jquery.autogrowtextarea.js"></script>

<script>

$(document).ready(function() {


    var colorArray = ["#0AC2D2", "#FDC162", "#60D7A9", "#E91E63"];
    var randomNum = Math.floor((Math.random() * colorArray.length));
    var userColor = colorArray[randomNum];

    $("body").css("background-color", userColor);
    $("#message").css("background-color", userColor);
    $("#message").autoGrow();

    //////////
    //TIMERS//
    //////////

    function twoMinTimer (userObj) {

      var time=2;
      var round=1;

      var timer=setInterval(timer, 1000);

      function timer () {
        time=time-1;
        $("#round").html("Round:" + round);
        $("#timer").html(time + " Seconds");

        if(time==0) {
          clearInterval(timer);
          kick(userObj);
        }
      }
    }

    function tenTimer (userObj) {

      var time=10;
      var round=1;

      var timer=setInterval(timer, 1000);

      function timer () {
        time=time-1;
        $("#round").html("Round:" + round);
        $("#timer").html(time + " Seconds");

        if(time==0) {
          clearInterval(timer);
          twoMinTimer(userObj);
        }
      }
    }
    
    ////////////////////
    //GLOBAL VARIABLES//
    ////////////////////

    var socket = io.connect('http://localhost:3000');

    var userCount = [];

    var userObj = {};

    //////////////
    //CONNECTION//
    //////////////

    //start connection
    socket.on("connect", function() {

        console.log("connected");
        // window.addEventListener("keydown", function(e) {
        //     if (e.keyCode == 13) sendMsg();      
        // });
    });

    $('#start').click(function() {

        var name = $('#name').val();
        var id = socket.id;
        userCount.push(id);
        console.log(userCount.length);
        socket.emit('joinRoom', {name: name, id: id, length: userCount.length});

        $('#name').empty();

        $("#startButtons").hide();
        $("#chat").css("display", "block");

    });

    socket.on('join', function(userObj) {

        if (userObj[socket.id].length < 3) {

            $("#round").html("Please wait for all players...");
            //$('#allMessages').append($('<div></div>').addClass('messageDiv').text(userObj.name));


        } else if (userObj[socket.id].length == 3) {

            socket.emit('ready', userObj);

            console.log(userObj[socket.id].name);
            console.log(userObj[socket.id].length);
            console.log(userObj[socket.id].leader);


        } else {

            // WAIT FOR AN OPENING STUFF

            console.log(userObj.name);

        }
        
    });

    //////////////
    //GAME START//
    //////////////

    socket.on('ready', function(userObj) {

            // GAME STUFF
            socket.emit(console.log("ALL GAME NOW PLEASE"));
            //console.log(JSON.stringify(userObj));
            $('#round').empty();
            $("#messageSection").css("display", "block"); 
            groupChat(); 

    });

    /////////
    //RESET//
    /////////

    function resetUserObj(type) {

        console.log("reset");

        socket.emit('reset');

        socket.on('resetReturn', function(userObj) {

            console.log(userObj);
            if (type == kick) {

                console.log("kick");

                kick(userObj);

            // } else if (type == vote) {

            //     vote(userObj);

            } else if (type == chat) {

                groupChat(userObj);

            }

            console.log(userObj);
        });

        

    }

    //////////////
    //GROUP CHAT//
    //////////////
    function groupChat() {

    $('#allMessages').empty(); 
    $('#messageSection').show();  

      // var time=6;

      // var timer=setInterval(timer, 1000);

      // function timer () {
      //   time=time-1;
      //   $("#round").html("Chat for " +time+ " more seconds!" );
      //   $("#timer").hide();

      //   if(time==0) {
      //     clearInterval(timer);
      //     resetUserObj(kick);
      //   }
      // }

    setTimeout(resetUserObj(kick), 5000);

    }

    function sendMsg() {

        var id = socket.id;
        var msg = $('#message').val();
        var msgPack = {id: id, msg: msg};

        socket.emit('chat message', msgPack);

        $('#message').val('');
        return false;
    }

    socket.on('chat', function(msgDeliver){
        $('#allMessages').append($('<div></div>').addClass('messageDiv').text(msgDeliver.name + ": " + msgDeliver.msg));
    });
    
    $('#send').click(function() {sendMsg()});



    ///////////////
    //LEADER KICK//
    ///////////////

    function kick(userObj) {

        console.log("KICKING");

        $('#messageSection').hide();
        $("#allMessages").empty();

        var newCount = 0;

        for (number in userObj) {
            newCount ++;
        }

        console.log(newCount);

        if (newCount > 1) {

            $('#header').css('display', 'none');

            //$("<div></div>").attr('id','name-holder');
            $('#messageSection').css('display', 'none');
                                   //.append($('#name-holder'));

            if (userObj[socket.id].leader == true) {

                for (var number in userObj) {
                    if (userObj[number].leader == false) {
                        $('#allMessages').append($("<div></div>").addClass('button kickerButton').text(userObj[number].name).attr('id', userObj[number].id));
                        $('#header').css('display', 'none');
                        $('#messageSection').css('display', 'none');
                    }
                }

                $('.kickerButton').click(function() {
                    nameID = this.id;
                    socket.emit('kickUser', nameID);

                })
                    
            } 

            else {

                $('#allMessages').append($("<div></div>").addClass('button info-block').text("You are not the leader. Please wait 10 seconds for the leader to kick someone! Hope it's not you. ;)"));

                //if leader = true
                //KICKER WINNER

                //if leader = false
                //OTHER WINNER
            }
        } else {

            console.log("GAME OVER");
            //GAME OVER
        }
    }

    socket.on('kickFinished', function(userObj) {

        var kickedID;

        for (each in userObj) {
            if (userObj[each].kicked == true) {
                kickedID = userObj[each].id;
            }
        }

        if (userObj[socket.id].kicked == false) {

            $("#allMessages").empty();
            $('#allMessages').append($("<div></div>").addClass('button info-block').text(userObj[kickedID].name+" has been kicked! Please wait while we start up the next round."));
            //console.log(userObj[kickedID].name+" has been kicked!");

            //   var time=5;

            //   var timer=setInterval(timer, 1000);

            //   function timer () {
            //     $('#header').css('display', 'block');
            //     time=time-1;
            //     $("#timer").html(time + " Seconds");

            //     if(time==0) {
            //       clearInterval(timer);
            //       resetUserObj(chat);
            //     }
            // }
            setTimeout(resetUserObj(chat), 5000);
            

        } else {
            
            $("#allMessages").empty();
            $('#allMessages').append($("<div></div>").addClass('button info-block').text("You've been kicked! Keep refreshing to try to join the next game!"));

            setTimeout(function(){ 
                location.reload();
            }, 3000);
        }


    });

    ////////////////////////
    //DISCONNECTION NOTICE//
    ////////////////////////

    socket.on('exitNotify', function(data) {
        console.log(data);
    })

});

</script>

</head>

<body>

   
    <div id="startButtons">

      <h1><strong>KICK</strong>STER</h1>
      <p> Every 30 seconds one person will have the ability to kick one person out of the chat. Guess who is kicking out members of your group before they kick out you!<p/>

      <input type="text" id="name" maxlength="20" placeholder="Name" required />

      <div class="button" id="start"> Start </div>

    </div>
    
    <div id="chat">

      <div id="header">
        <h1 id="round"></h1>
        <h1 id="timer"></h1>
      </div>

      <div id="allMessages"></div>

      <div id="messageSection">

        <textarea id="message" maxlength="200" placeholder="Your Message" required></textarea>

        <div class="button" id="send"> Send </div>

      </div>

    </div>


</body>
</html>